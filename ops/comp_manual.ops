
ros.import("lcsr_controllers");

/* Create Feed-Forward inverse dynamics component */
loadComponent("inverse_dynamics","lcsr_controllers::IDControllerKDL");
connect("barrett_manager.wam.position_out", "inverse_dynamics.joint_position_in", ConnPolicy());
connect("barrett_manager.wam.velocity_out", "inverse_dynamics.joint_velocity_in", ConnPolicy());

/* Create manual joint-space PID controller loop */
loadComponent("man_pid","lcsr_controllers::JointPIDController");
loadComponent("man_traj","lcsr_controllers::JointTrajGeneratorKDL");

connect("barrett_manager.wam.position_out", "man_pid.joint_position_in", ConnPolicy());
connect("barrett_manager.wam.velocity_out", "man_pid.joint_velocity_in", ConnPolicy());
connect("man_traj.joint_position_out", "man_pid.joint_position_cmd_in", ConnPolicy());
connect("man_traj.joint_velocity_out", "man_pid.joint_velocity_cmd_in", ConnPolicy());

connect("barrett_manager.wam.position_out", "man_traj.joint_position_in", ConnPolicy());

connect("man_pid.joint_effort_out", "wam_effort_sum.feedback_in", ConnPolicy());
connect("inverse_dynamics.joint_effort_out", "wam_effort_sum.feedforward_in", ConnPolicy());

connect("wam_effort_sum.sum_out", "barrett_manager.wam.effort_in", ConnPolicy());

/* Create RML traj generator */
loadComponent("rml_traj","lcsr_controllers::JointTrajGeneratorRML");
connect("rml_traj.joint_position_out", "man_pid.joint_position_cmd_in", ConnPolicy());
connect("rml_traj.joint_velocity_out", "man_pid.joint_velocity_cmd_in", ConnPolicy());

connect("barrett_manager.wam.position_out", "rml_traj.joint_position_in", ConnPolicy());
connect("barrett_manager.wam.velocity_out", "rml_traj.joint_velocity_in", ConnPolicy());

//loadService("rml_traj","actionlib");
//rml_traj.actionlib.connect("/some/ros/namespace/my_action");

man_pid.configure();
man_traj.configure();
inverse_dynamics.configure();
rml_traj.configure();

/* Configure conman interface */
addPeer("scheme","man_pid");
addPeer("scheme","man_traj");
addPeer("scheme","inverse_dynamics");
addPeer("scheme","rml_traj");

/* Create manual group  */
scheme.addGroup("manual");
scheme.addToGroup("man_pid","manual");
scheme.addToGroup("man_traj","manual");

/* Add ID controller */
scheme.addBlock("inverse_dynamics");
scheme.addBlock("rml_traj");
